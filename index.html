<script>
/* =========================================================
   APP VERSION — BUMP THIS EVERY DEPLOY
   ========================================================= */
window.APP_VERSION = "6";   // ⬅️ change to 7, 8, 9 on each update

(function () {

  /* =========================================================
     POINT 3: HARD KILL-SWITCH FOR STALE CLIENTS
     ========================================================= */
  const VERSION_KEY = "mmp_app_version";
  const currentVersion = String(window.APP_VERSION);
  const storedVersion = localStorage.getItem(VERSION_KEY);

  const forceHardReload = () => {
    // Clear all caches
    if ('caches' in window) {
      caches.keys().then(keys =>
        Promise.all(keys.map(k => caches.delete(k)))
      );
    }

    // Unregister all service workers
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations()
        .then(regs => Promise.all(regs.map(r => r.unregister())))
        .finally(() => {
          localStorage.setItem(VERSION_KEY, currentVersion);
          location.reload(true);
        });
    } else {
      localStorage.setItem(VERSION_KEY, currentVersion);
      location.reload(true);
    }
  };

  if (storedVersion && storedVersion !== currentVersion) {
    forceHardReload();
    return; // stop old JS execution
  }

  if (!storedVersion) {
    localStorage.setItem(VERSION_KEY, currentVersion);
  }

  /* =========================================================
     MODAL HELPER
     ========================================================= */
  function setupModal(openBtnId, modalId, closeBtnId) {
    const openBtn = document.getElementById(openBtnId);
    const modal = document.getElementById(modalId);
    const closeBtn = document.getElementById(closeBtnId);

    if (!openBtn || !modal || !closeBtn) return {};

    const openModal = () => {
      document.querySelectorAll('.modalOverlay.active').forEach(m => {
        m.classList.remove('active');
      });
      modal.classList.add('active');
      closeBtn.focus();
    };

    const closeModal = () => {
      modal.classList.remove('active');
      openBtn.focus();
    };

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', e => {
      if (e.target === modal) closeModal();
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        closeModal();
      }
    });

    return { openModal };
  }

  setupModal('openDisclaimer', 'disclaimerModal', 'closeDisclaimer');
  const preRead = setupModal('openPreRead', 'preReadModal', 'closePreRead');

  /* =========================================================
     FORCED "PLEASE READ" GATE
     ========================================================= */
  const STORAGE_KEY = 'mmp_preread_accepted_v1';
  const calcBtn = document.getElementById('calcBtn');
  const ackCheckbox = document.getElementById('ackCheckbox');
  const acceptBtn = document.getElementById('acceptPreRead');
  const hint = document.getElementById('preReadHint');

  const isAccepted = () => localStorage.getItem(STORAGE_KEY) === 'true';

  const setAcceptedUI = accepted => {
    if (!calcBtn) return;
    calcBtn.disabled = !accepted;
    if (hint) hint.style.display = accepted ? 'none' : 'block';
  };

  setAcceptedUI(isAccepted());

  if (calcBtn) {
    calcBtn.addEventListener('click', e => {
      if (!isAccepted()) {
        e.preventDefault();
        e.stopPropagation();
        preRead.openModal?.();
      }
    }, true);
  }

  if (ackCheckbox && acceptBtn) {
    const sync = () => acceptBtn.disabled = !ackCheckbox.checked;
    ackCheckbox.addEventListener('change', sync);
    sync();

    acceptBtn.addEventListener('click', () => {
      localStorage.setItem(STORAGE_KEY, 'true');
      localStorage.setItem(STORAGE_KEY + '_ts', new Date().toISOString());
      setAcceptedUI(true);
      document.getElementById('preReadModal')?.classList.remove('active');
      calcBtn?.focus();
    });
  }

  /* =========================================================
     LOA ROUND-UP FIX (UP TO 3 DECIMALS → CEIL)
     ========================================================= */
  const loaInput = document.getElementById('loaInput');

  const roundUpLOA = () => {
    if (!loaInput) return;
    const raw = loaInput.value.trim();
    if (!raw) return;
    const n = Number(raw);
    if (isNaN(n)) return;
    loaInput.value = Math.ceil(n).toString();
  };

  loaInput?.addEventListener('blur', roundUpLOA);
  calcBtn?.addEventListener('click', roundUpLOA, true);

  /* =========================================================
     POINT 2: SERVICE WORKER AUTO-UPDATE + RELOAD
     ========================================================= */
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').then(reg => {

      if (reg.waiting) {
        reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      }

      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        if (!newWorker) return;

        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed') {
            location.reload();
          }
        });
      });
    });
  }

})();
</script>
