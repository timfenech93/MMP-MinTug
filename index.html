<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MMP MinTug</title>

  <!-- Force browsers to revalidate HTML (helps with GitHub Pages + mobile caches) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" alt="" />
  <meta name="theme-color" content="#0B3C5D" />

  <!-- Version query strings help bust cache for CSS/JS -->
  <link rel="stylesheet" href="styles.css?v=4" />
</head>

<body>
  <div class="app">
    <header class="header">
      <div class="brand">
        <img class="logo" src="icons/icon-192.png" alt="App icon" />
        <h1 class="title">MMP MinTug</h1>
      </div>

      <div class="controls">
        <div class="row">
          <button id="btnBerth" class="chip chip-selected" type="button">Berthing</button>
          <button id="btnUnberth" class="chip" type="button">Unberthing</button>
        </div>

        <label class="field">
          <span class="label">Jetty / Location</span>
          <select id="locationSelect" class="input"></select>
        </label>

        <label class="field">
          <span class="label">LOA (m)</span>
          <input id="loaInput" class="input" inputmode="decimal" placeholder="e.g. 280.125" />
        </label>

        <button id="calcBtn" class="primary" type="button">Calculate</button>

        <div id="error" class="error" role="alert" aria-live="polite"></div>
      </div>
    </header>

    <main class="results" id="results">
      <div id="emptyState" class="muted">
        Select Berth, Choose Berthing or Unberthing, Enter LOA and press <b>Calculate</b>.
      </div>

      <section id="resultCard" class="card hidden" aria-live="polite">
        <div class="resultTop">
          <div class="resultLabel">Required tugs</div>
          <div id="tugsOut" class="tugs">—</div>
        </div>

        <div class="kv">
          <div class="k">LOA Group</div>
          <div id="bandOut" class="v">—</div>
        </div>

        <div class="block">
          <div class="blockTitle">Notes or Exceptions</div>
          <div id="ruleOut" class="blockBody muted">—</div>
        </div>

        <div class="block">
          <div class="blockTitle">Additional notes</div>
          <div id="notesOut" class="blockBody muted">—</div>
        </div>
      </section>

      <div class="footer">
        <hr />

        <!-- PRE-READ (forced before Calculate) -->
        <div class="preReadBox">
          <div class="preReadTitle">Please read before using the calculator.</div>

          <button id="openPreRead" class="modalBtn infoPrimary" type="button">
            Please read before using the calculator
          </button>

          <p id="preReadHint" class="preReadHint">
            You must read and acknowledge the above before you can use <b>Calculate</b>.
          </p>
        </div>

        <!-- Disclaimer -->
        <button id="openDisclaimer" class="modalBtn legalPrimary" type="button">
          Disclaimer
        </button>
      </div>
    </main>
  </div>

  <!-- PRE-READ MODAL -->
  <div id="preReadModal" class="modalOverlay" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="preReadTitle">
      <h2 id="preReadTitle" class="modalTitle">
        Please read before using the calculator
      </h2>

      <div class="modalBody">
        <p>The requirements for tug usage provided by this app are being made on the basis of the following:</p>

        <ol>
          <li>That they do not impinge upon the rights and obligations of ships Master and Pilots undertaking ship movements, to conduct their operations in accordance with ordinary practices of good seamanship.</li>
          <li>That the Ship's Master always retains the right to require additional tug resources should he deem fit.</li>
          <li>That the Chief Pilot or the Pilot conducting the movement may recommend additional tug or pilot resources as they deem fit and agreed by the Master, on the basis of their professional judgement and after taking into consideration the prevailing circumstances and conditions.</li>
          <li>That regardless of weather and other conditions and considerations, the Harbour Master is the ultimate arbiter when an issue of safety arises in the context of a request being made by the ship owner for the provisions of lesser tug resources than those listed below.</li>
          <li>The Authority reserves the right, at her own discretion, to alter Tug resources as listed below, taking into consideration the circumstances of the case.</li>
          <li>These norms apply for normal conditions.</li>
          <li>In case of disabled vessels, cold moves or exceptional circumstances, including but not limited to, inclement weather, impracticable approaches, confined terminals and vessel displacement to power ratio, Tug and Pilot requirements may be increased based on an assessment conducted by the Ship's Master and the Pilot and confirmed by the Harbour Master.</li>
          <li>Tug/s over and above the minimum tug requirements as set out in the attached Annexes may be ordered on a standby basis. This also applies to vessels that are exempt from these requirements. Tug/s ordered on a standby basis will be deployed to the area of operation and will be charged at a rate of 50% of the Towage (Tariff of Rates) Regulations, subject that the tug/s is/are not requested to take an active part in the ship assist operation. In the case tug/s is/are requested to assist during the ship assist operation, the full rate as per Towage (Tariff of Rates) Regulations shall be levied.</li>
          <li>Day light restrictions apply in the case of specific berths and docking operations.</li>
        </ol>

        <p>
          <b>N.B.</b> For more information please refer to the Minimum Towage Requirement, latest revision.
          At the time of writing, the latest revision is <b>3.0</b>, published as <b>Port Notice 02 of 2025</b>.
        </p>

        <p>
          Official document:
          <a
            href="https://www.transport.gov.mt/include/filestreaming.asp?fileid=10554"
            target="_blank"
            rel="noopener noreferrer"
          >Port Notice 02/2025 — Minimum Towage Requirements (Rev 3.0)</a>
        </p>

        <div class="ackRow">
          <input id="ackCheckbox" type="checkbox" />
          <label for="ackCheckbox" class="ackText">
            I confirm that I have read and understood the above information and I acknowledge that the output of this calculator does not replace professional judgement and applicable notices/regulations.
          </label>
        </div>
      </div>

      <div class="modalActions">
        <button id="acceptPreRead" class="modalBtn infoPrimary" type="button" disabled>
          I Agree / Continue
        </button>
        <button id="closePreRead" class="modalBtn secondary" type="button">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- DISCLAIMER MODAL -->
  <div id="disclaimerModal" class="modalOverlay" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="disclaimerTitle">
      <h2 id="disclaimerTitle" class="modalTitle">
        Important Information & Disclaimer
      </h2>

      <div class="modalBody">
        <p>
          Whilst the Malta Maritime Pilots Co-Operative Ltd has endeavoured to ensure that the material supplied is suitable and correct at the date of publication, the Malta Maritime Pilots Co-Operative Ltd. accepts no liability for any damage or loss of any nature arising from the use of this app or any information contained within it.
        </p>

        <p>
          The material supplied is used entirely at the user’s own risk and the information or diagrams may not be reproduced without the developer's written consent.
        </p>

        <p>
          The information contained in this app has to be read and construed in conjunction with the applicable notice to mariners at that particular time of use.
        </p>
      </div>

      <div class="modalActions">
        <button id="closeDisclaimer" class="modalBtn secondary" type="button">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Version query string helps bust cache for app.js -->
  <script src="app.js?v=4"></script>

  <script>
    (function () {
      // -------- Modal helper ----------
      function setupModal(openBtnId, modalId, closeBtnId) {
        const openBtn = document.getElementById(openBtnId);
        const modal = document.getElementById(modalId);
        const closeBtn = document.getElementById(closeBtnId);

        if (!openBtn || !modal || !closeBtn) return;

        const openModal = () => {
          // Close any other open modal first
          document.querySelectorAll('.modalOverlay.active').forEach(m => {
            m.classList.remove('active');
            m.setAttribute('aria-hidden', 'true');
          });

          modal.classList.add('active');
          modal.setAttribute('aria-hidden', 'false');
          closeBtn.focus();
        };

        const closeModal = () => {
          modal.classList.remove('active');
          modal.setAttribute('aria-hidden', 'true');
          openBtn.focus();
        };

        openBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);

        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
          }
        });

        return { openModal, closeModal };
      }

      // Disclaimer modal
      setupModal('openDisclaimer', 'disclaimerModal', 'closeDisclaimer');

      // Pre-read modal
      const preRead = setupModal('openPreRead', 'preReadModal', 'closePreRead');

      // -------- Forced "Please read" gate ----------
      const STORAGE_KEY = 'mmp_preread_accepted_v1';

      const calcBtn = document.getElementById('calcBtn');
      const hint = document.getElementById('preReadHint');

      const ackCheckbox = document.getElementById('ackCheckbox');
      const acceptBtn = document.getElementById('acceptPreRead');

      const isAccepted = () => localStorage.getItem(STORAGE_KEY) === 'true';

      const setAcceptedUI = (accepted) => {
        if (!calcBtn) return;

        calcBtn.disabled = !accepted;
        calcBtn.setAttribute('aria-disabled', String(!accepted));

        if (hint) {
          hint.style.display = accepted ? 'none' : 'block';
        }
      };

      // Initial state on load
      setAcceptedUI(isAccepted());

      // If not accepted, block Calculate clicks and prompt modal
      if (calcBtn) {
        calcBtn.addEventListener('click', (e) => {
          if (!isAccepted()) {
            e.preventDefault();
            e.stopPropagation();
            if (preRead && preRead.openModal) preRead.openModal();
            return;
          }
        }, true);
      }

      // Enable "I Agree" only when checkbox is ticked
      if (ackCheckbox && acceptBtn) {
        const syncAccept = () => {
          acceptBtn.disabled = !ackCheckbox.checked;
        };
        ackCheckbox.addEventListener('change', syncAccept);
        syncAccept();

        acceptBtn.addEventListener('click', () => {
          localStorage.setItem(STORAGE_KEY, 'true');
          localStorage.setItem(STORAGE_KEY + '_ts', new Date().toISOString());
          setAcceptedUI(true);

          // close modal
          const modal = document.getElementById('preReadModal');
          if (modal) {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
          }

          // focus Calculate for convenience
          if (calcBtn) calcBtn.focus();
        });
      }

      // -------- LOA ROUND-UP FIX ----------
      const loaInput = document.getElementById('loaInput');

      const roundUpLOA = () => {
        if (!loaInput) return;
        const raw = loaInput.value.trim();
        if (raw === '') return;

        const num = Number(raw);
        if (isNaN(num)) return;

        const rounded = Math.ceil(num);
        loaInput.value = String(rounded);
      };

      loaInput?.addEventListener('blur', roundUpLOA);
      calcBtn?.addEventListener('click', roundUpLOA, true);

      // -------- Service Worker: force update + reload on new version ----------
      // IMPORTANT: Also bump your CACHE_NAME version inside service-worker.js on each deploy.
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js').then((reg) => {
          // If there's already a waiting worker, activate it immediately
          if (reg.waiting) {
            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          }

          // When a new worker is found, reload once it's installed
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            if (!newWorker) return;

            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed') {
                // Reload to pick up the latest assets
                window.location.reload();
              }
            });
          });
        });
      }
    })();
  </script>
</body>
</html>
