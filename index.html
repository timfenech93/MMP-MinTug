<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MMP MinTug</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" alt="" />
  <meta name="theme-color" content="#0B3C5D" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* ===== BUTTON BASE ===== */
    .modalBtn {
      width: 100%;
      padding: 14px 16px;
      border-radius: 14px;
      border: none;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease, opacity 0.15s ease;
    }
    .modalBtn:hover { opacity: 0.95; }
    .modalBtn:active { transform: translateY(1px); }

    .modalBtn.infoPrimary {
      background: linear-gradient(135deg, #0B3C5D, #145A82);
      color: #fff;
    }

    .modalBtn.legalPrimary {
      background: linear-gradient(135deg, #F4B400, #E09B00);
      color: #2b1c00;
    }

    .modalBtn.secondary {
      background: #eee;
      color: #333;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .preReadBox {
      margin: 12px 0;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
    }

    .preReadTitle {
      font-size: 13px;
      font-weight: 800;
      margin-bottom: 10px;
    }

    .modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 14px;
    }
    .modalOverlay.active { display: flex; }

    .modalCard {
      background: #fff;
      width: 92%;
      max-width: 560px;
      max-height: 85vh;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modalTitle {
      padding: 16px;
      font-size: 16px;
      font-weight: 900;
      border-bottom: 1px solid #eee;
    }

    .modalBody {
      padding: 16px;
      font-size: 13px;
      line-height: 1.45;
      overflow-y: auto;
    }

    .modalActions {
      padding: 12px 16px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
<div class="app">
  <header class="header">
    <div class="brand">
      <img class="logo" src="icons/icon-192.png" alt="App icon" />
      <h1 class="title">MMP MinTug</h1>
    </div>

    <div class="controls">
      <div class="row">
        <button id="btnBerth" class="chip chip-selected">Berthing</button>
        <button id="btnUnberth" class="chip">Unberthing</button>
      </div>

      <label class="field">
        <span class="label">Jetty / Location</span>
        <select id="locationSelect" class="input"></select>
      </label>

      <label class="field">
        <span class="label">LOA (m)</span>
        <input id="loaInput" class="input" inputmode="decimal" placeholder="e.g. 280.125" />
      </label>

      <button id="calcBtn" class="primary">Calculate</button>
      <div id="error" class="error"></div>
    </div>
  </header>

  <main class="results">
    <div class="footer">
      <hr />

      <div class="preReadBox">
        <div class="preReadTitle">Please read before using the calculator.</div>
        <button id="openPreRead" class="modalBtn infoPrimary">
          Please read before using the calculator
        </button>
      </div>

      <button id="openDisclaimer" class="modalBtn legalPrimary">
        Disclaimer
      </button>
    </div>
  </main>
</div>

<!-- PRE-READ MODAL -->
<div id="preReadModal" class="modalOverlay">
  <div class="modalCard">
    <div class="modalTitle">Please read before using the calculator</div>
    <div class="modalBody">
      <p>
        For more information please refer to the Minimum Towage Requirement,
        latest revision 3.0 – Port Notice 02 of 2025.
      </p>

      <p>
        <a href="https://www.transport.gov.mt/include/filestreaming.asp?fileid=10554"
           target="_blank" rel="noopener noreferrer">
          Port Notice 02/2025 – Minimum Towage Requirements (Rev 3.0)
        </a>
      </p>

      <label>
        <input id="ackCheckbox" type="checkbox" />
        I have read and understood the above.
      </label>
    </div>

    <div class="modalActions">
      <button id="acceptPreRead" class="modalBtn infoPrimary" disabled>I Agree / Continue</button>
      <button id="closePreRead" class="modalBtn secondary">Close</button>
    </div>
  </div>
</div>

<!-- DISCLAIMER MODAL -->
<div id="disclaimerModal" class="modalOverlay">
  <div class="modalCard">
    <div class="modalTitle">Important Information & Disclaimer</div>
    <div class="modalBody">
      <p>
        Whilst the Malta Maritime Pilots Co-Operative Ltd has endeavoured to ensure accuracy,
        no liability is accepted for loss or damage arising from the use of this app.
      </p>
    </div>
    <div class="modalActions">
      <button id="closeDisclaimer" class="modalBtn secondary">Close</button>
    </div>
  </div>
</div>

<script src="app.js"></script>

<script>
(function () {

  /* ===== MODAL HANDLER ===== */
  function modal(openId, modalId, closeId) {
    const o = document.getElementById(openId);
    const m = document.getElementById(modalId);
    const c = document.getElementById(closeId);
    if (!o || !m || !c) return;

    o.onclick = () => m.classList.add('active');
    c.onclick = () => m.classList.remove('active');
    m.onclick = e => { if (e.target === m) m.classList.remove('active'); };
  }

  modal('openPreRead','preReadModal','closePreRead');
  modal('openDisclaimer','disclaimerModal','closeDisclaimer');

  /* ===== FORCE PRE-READ ===== */
  const STORAGE = 'mmp_preread_ok';
  const calcBtn = document.getElementById('calcBtn');
  const ack = document.getElementById('ackCheckbox');
  const accept = document.getElementById('acceptPreRead');

  const accepted = () => localStorage.getItem(STORAGE) === 'true';

  if (calcBtn) calcBtn.disabled = !accepted();

  if (ack && accept) {
    ack.onchange = () => accept.disabled = !ack.checked;
    accept.onclick = () => {
      localStorage.setItem(STORAGE, 'true');
      document.getElementById('preReadModal').classList.remove('active');
      if (calcBtn) calcBtn.disabled = false;
    };
  }

  if (calcBtn) {
    calcBtn.addEventListener('click', e => {
      if (!accepted()) {
        e.preventDefault();
        document.getElementById('preReadModal').classList.add('active');
      }
    }, true);
  }

  /* ===== LOA ROUND-UP FIX (CRITICAL) ===== */
  const loaInput = document.getElementById('loaInput');

  const roundUpLOA = () => {
    if (!loaInput || loaInput.value.trim() === '') return;
    const n = Number(loaInput.value);
    if (isNaN(n)) return;
    loaInput.value = Math.ceil(n).toString();
  };

  // Round when leaving field
  loaInput?.addEventListener('blur', roundUpLOA);

  // Round BEFORE backend logic
  calcBtn?.addEventListener('click', roundUpLOA, true);

})();
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js');
  }
</script>
</body>
</html>
